generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id             String     @id @default(auto()) @map("_id") @db.ObjectId
  email          String     @unique
  emailVerified  DateTime?
  hashedPassword String?
  firstName      String
  lastName       String
  name           String?
  referralSource String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  addresses      Address[]
  checkoutSessions CheckoutSession[]
  subscriptions  Subscription[]
  accounts       Account[]
  sessions       Session[]
}

model Address {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  label       String?
  street      String
  city        String
  state       String
  postalCode  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id])
  userId      String   @db.ObjectId

  @@index([userId])
}

model Account {
  id                String  @id @default(auto()) @map("_id") @db.ObjectId
  userId            String  @db.ObjectId
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.String
  access_token      String? @db.String
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.String
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  id         String @id @default(auto()) @map("_id") @db.ObjectId
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model CheckoutSession {
  id                   String          @id @default(auto()) @map("_id") @db.ObjectId
  userId               String          @db.ObjectId
  user                 User            @relation(fields: [userId], references: [id])
  stripeSessionId      String?
  status               CheckoutStatus  @default(PENDING)
  planId               String?
  planName             String?
  addressId            String?
  addressLabel         String?
  addressStreet        String
  addressCity          String
  addressState         String
  addressPostalCode    String
  addressSummary       String
  services             Json
  monthlyTotal         Float?
  stripeStatus         String?
  stripePaymentStatus  String?
  stripeCustomerId     String?
  stripeSubscriptionId String?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  completedAt          DateTime?

  @@index([userId])
  @@index([stripeSessionId])
}

enum CheckoutStatus {
  PENDING
  COMPLETED
  CANCELLED
}

model Subscription {
  id                   String             @id @default(auto()) @map("_id") @db.ObjectId
  userId               String             @db.ObjectId
  user                 User               @relation(fields: [userId], references: [id])
  planId               String?
  planName             String?
  addressId            String?
  addressLabel         String?
  addressStreet        String
  addressCity          String
  addressState         String
  addressPostalCode    String
  services             Json
  monthlyTotal         Float?
  status               SubscriptionStatus @default(ACTIVE)
  stripeCustomerId     String?
  stripeSubscriptionId String?
  stripeStatus         String?
  stripePaymentStatus  String?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  cancelledAt          DateTime?

  @@index([userId])
  @@index([stripeSubscriptionId])
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
}
